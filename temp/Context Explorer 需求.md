# 新功能 --「Context Explorer」需求與設計規格說明

## 背景與目的

「Context Explorer」功能使用者可以透過 VSCode 側邊欄面板 (Side Bar View)，選取目前專案中的多個檔案，將其內容快速複製到剪貼簿，以提供給 AI 模型作為上下文 (context) 使用。此功能旨在簡化將多個檔案內容提供給 AI 模型的工作流程需求。

## 主要功能需求

### 1. 檔案選取與內容複製

- **標準勾選框**：
  - 每個檔案/資料夾項目的左側必須顯示標準的方形勾選框（checkbox）
  - 勾選框必須能直接透過點擊切換選取/取消選取狀態
  - 未選取狀態顯示為空白方框，選取狀態顯示為帶勾號的方框
  - 勾選框必須與檔案/資料夾名稱保持適當間距，且垂直對齊

- **階層選取行為**：
  - 當勾選資料夾時，自動連帶勾選其內所有子檔案
  - 當取消勾選資料夾時，自動取消勾選其內所有子檔案
  - 當部分子檔案被選取時，父資料夾應顯示為「部分選取」狀態

- **複製功能**：
  - 點擊「複製到剪貼簿」按鈕後，將所有勾選檔案的內容複製到剪貼簿
  - 複製過程中顯示進度指示
  - 複製完成後顯示成功訊息，包含複製的檔案數量和總 tokens 數

### 2. 檔案列表與篩選功能

- **樹狀檔案列表**：
  - 檔案列表呈現為可展開與摺疊的樹狀結構
  - 檔案和資料夾使用不同圖示區分
  - 每個項目右側顯示 tokens 數量，若設定 tokens 上限，則同時顯示百分比

- **篩選框**：
  - 必須實作為固定位於檔案列表上方的搜尋輸入框
  - 輸入框左側顯示搜尋圖示，右側顯示清除按鈕
  - 預設顯示提示文字「搜尋檔案...」
  - 輸入時即時篩選檔案列表，根據檔案名稱進行模糊比對
  - 清除按鈕點擊後立即清空篩選條件並重置檔案列表
  - 篩選功能僅根據檔案名稱進行比對，不需額外排序
  - 提供一個開關，可讓使用者選擇是否只顯示已勾選的檔案

### 3. 底部摘要列

- **摘要列設計**：
  - 必須實作為固定在檔案列表底部的資訊區域
  - 左側顯示已選取檔案數量（例如：「6 files selected」）
  - 左側同時顯示已選取檔案的總 tokens 數量
  - 若設定 tokens 上限，則顯示進度條和百分比
  - 右側顯示「複製到剪貼簿」按鈕，使用藍色突顯
  - 勾選與取消時，摘要列應立即反映最新的檔案數量及預估 Tokens 總量

### 4. 狀態持久化與自動更新

- **持久化要求**：
  - Context Explorer 的狀態 (如選取勾選狀態、資料夾展開或摺疊狀態) 應在 VSCode 關閉後保留，下次開啟時恢復
  - 重新開啟 VSCode 後，必須立即完全恢復之前的選取狀態
  - 選取功能在狀態恢復後必須維持正常操作，包括選取/取消選取功能
  - 狀態必須按專案區分儲存，避免跨專案干擾

- **檔案變更處理**：
  - 若上次勾選的檔案已經被刪除或不存在，則下次開啟時自動取消該檔案的勾選狀態，並即時更新摘要列資訊
  - 檔案移動或重命名後，應正確追蹤檔案狀態

## 技術實作細節

### 1. UI 整合

- **視圖容器結構**：
  - 在 package.json 中註冊專用的視圖容器 (viewContainer)
  - 僅註冊一個單一視圖（ContextExplorerView），此視圖內部同時包含篩選框、檔案列表和摘要列三個元素
  - 篩選框固定於視圖頂部，檔案列表位於中間可垂直滾動區域，摘要列固定於底部
  - 三個元素之間不得使用分隔線或視覺分割，應呈現為一個整體單獨區塊
  - 視覺風格應統一且連貫，避免明顯的視圖分隔或邊界線

- **視圖實作方式**：
  - **使用單一 Webview 實作**，不再使用 VSCode 原生 TreeView API
  - 內部建議使用 HTML/CSS/JavaScript 框架（如 React、Vue、Svelte 或純 JS）自行實作樹狀檔案列表元件，支援可展開摺疊的樹狀結構、勾選框、以及檔案項目的 token 數量顯示
  - 篩選框和摘要列也在同一個 Webview 中以 HTML/CSS/JS 完成實作
  - 篩選框即時篩選檔案列表內容，並即時更新檔案列表視圖
  - 摘要列即時根據選取狀態、token數量更新內容，左側顯示檔案數量與總 tokens，右側提供複製按鈕
  
- **Webview 與擴展主程序通信**：
  - Webview 內部 UI 操作（如篩選、勾選、展開/摺疊）實時通知擴展主程序
  - 擴展主程序根據檔案系統變化（新增、刪除、移動、重命名）即時通知 Webview 更新檔案列表與勾選狀態

### 2. API 使用指南

- **檔案勾選實作**：
  - 由於 VSCode TreeView 不直接支援勾選框，必須自定義勾選框元素
  - 在 Webview 中使用 HTML/CSS/JavaScript 自行實作勾選框元素
  - 實作點擊切換勾選狀態的事件處理機制
  - 針對資料夾項目實作連動勾選/取消勾選所有子項目的功能

- **Webview 通信**：
  - 使用 postMessage 和 onDidReceiveMessage 建立 Webview 與擴展主程序間的通信
  - 確保訊息傳遞的同步和穩定性
  - 所有檔案操作（如獲取檔案列表、讀取檔案內容）都由擴展主程序處理，並通過消息傳遞給 Webview
  - Webview 中的 UI 狀態變更（如勾選狀態、展開/摺疊狀態）通過消息傳遞給擴展主程序以便持久化保存

- **狀態儲存**：
  - 使用 extensionContext.workspaceState 或 extensionContext.globalState 儲存狀態
  - 狀態格式需包含文件 URI、選取狀態和展開狀態
  - 在擴展啟動時立即載入並應用已儲存的狀態
  - 按專案區分儲存狀態，避免跨專案干擾
  - 當 Webview 初始化時，傳送已保存的狀態給 Webview 以恢復 UI 狀態

- **檔案監控與狀態更新**：
  - 使用 VSCode 的檔案系統監控 API（FileSystemWatcher）監聽檔案變化
  - 當檔案被刪除、移動或重命名時，通過消息通知 Webview 更新 UI
  - Webview 接收到文件變更通知後，即時更新檔案列表和勾選狀態

### 3. 性能處理策略

- **大型專案和檔案處理**：
  - 在 Webview 中實作虛擬滾動（virtual scrolling）機制，僅渲染可見區域的檔案項目
  - 大型檔案列表採用分頁加載策略，由主程序分批傳送檔案資訊給 Webview
  - 設定單一檔案大小上限（例如 5MB），超過上限的檔案需要警告使用者

- **篩選性能優化**：
  - 在 Webview 中實作篩選節流（debounce，約 300ms），減少頻繁輸入時的性能問題
  - 使用效率高的模糊比對演算法，支援大型專案篩選
  - 僅在檔案名稱上執行篩選，不篩選檔案內容
  - 篩選操作優先在 Webview 端完成，避免不必要的通信開銷

- **檔案系統限制**：
  - 預設排除特定類型的檔案或資料夾（如 node_modules、.git、build、dist、bin 等）
  - 忽略二進制檔案、圖片等非文字檔案
  - 檔案列表初始加載由主程序準備，應用排除規則後再傳送到 Webview

## 輸出格式與現有功能整合

1. **輸出格式**：
   - 使用與現有 Copy For AI 功能相同的基本格式（簡單格式，無上下文分析）
   - 應用現有的 copyForAI.outputFormat 設定（markdown、xml、json、custom）
   - 複製整個檔案時不顯示行數，直接以檔案名稱作為標題
   - 不使用 Copy For AI (With Context) 的進階功能
   - 格式處理邏輯應在擴展主程序中進行，Webview 僅負責觸發複製操作

2. **交互方式**：
   - 提供固定的側邊欄，內含單一 Webview
   - Webview 負責所有使用者互動和 UI 呈現
   - 複製操作由 Webview 觸發，但實際的檔案讀取和格式處理由主程序執行

## 使用者互動流程

1. **開啟流程**：
   - 點擊左側活動欄中的「Copy For AI」圖示，開啟側邊欄
   - 側邊欄加載單一 Webview，其中包含篩選框（頂部）、檔案樹（中間）和摘要列（底部）
   - 擴展主程序載入之前儲存的選取狀態，並通過消息傳送給 Webview
   - Webview 初始化完成後立即應用已儲存的檔案選取和展開/摺疊狀態

2. **選取流程**：
   - 在 Webview 中點擊檔案/資料夾前的勾選框，切換選取狀態
   - 選取狀態變更時，Webview 即時更新 UI 並向主程序發送消息更新狀態
   - 資料夾選取狀態變更時，Webview 中的所有子項目同步更新勾選狀態
   - 摘要列在 Webview 中即時更新檔案數量和 token 預估

3. **搜尋流程**：
   - 在 Webview 中的篩選框中輸入文字，檔案列表即時篩選
   - 點擊清除按鈕或按下 ESC 鍵，清除搜尋條件
   - 篩選操作完全在 Webview 端完成，無需與主程序通信

4. **複製流程**：
   - 點擊 Webview 中摘要列上的「複製到剪貼簿」按鈕
   - Webview 向主程序發送複製請求，包含所有已選取檔案的資訊
   - 主程序讀取所有選取檔案內容，應用格式處理，並複製到剪貼簿
   - 複製過程中，主程序通知 Webview 顯示進度指示器
   - 複製完成後，主程序通知 Webview 顯示成功訊息
   - 內容已複製到剪貼簿，可直接貼到 AI 工具中

## 輸出格式範例

````markdown
## File: src/extension.ts
```typescript
import * as vscode from 'vscode';
import { processCode, removeComments } from './codeAnalyzer';
import { formatOutput } from './formatter';

export function activate(context: vscode.ExtensionContext) {
    console.log('擴展 "copy-for-ai" 已啟動！');
}
```

## File: src/file2.ts
```typescript
export function activate(context: vscode.ExtensionContext) {
    console.log('擴展 "copy-for-ai" 已啟動！');
}
```
````

## 實作檢查清單

為確保功能符合需求，請確認以下項目：

- [ ] Webview 正確載入並顯示在側邊欄
- [ ] 檔案勾選框在 Webview 中顯示且可正常切換狀態
- [ ] 資料夾選取行為正確，能連帶選取/取消選取所有子項目
- [ ] 篩選框位於 Webview 頂部，並能即時篩選文件
- [ ] 摘要列在 Webview 底部顯示，包含選取數量、tokens 數及複製按鈕
- [ ] Webview 與擴展主程序間通信正常，狀態同步無誤
- [ ] 重新開啟 VSCode 後，Webview 能正確恢復之前的選取狀態
- [ ] Token 數量和百分比正確計算和顯示
- [ ] 複製功能能正確將所有選取文件內容複製到剪貼簿
- [ ] Webview 在各種螢幕尺寸下顯示正常，支援響應式設計