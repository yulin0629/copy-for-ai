# 新功能 --「Context Explorer」需求與設計規格說明

## 背景與目的

「Context Explorer」功能使用者可以透過 VSCode 側邊欄面板 (Side Bar View)，選取目前專案中的多個檔案，將其內容快速複製到剪貼簿，以提供給 AI 模型作為上下文 (context) 使用。此功能旨在簡化將多個檔案內容提供給 AI 模型的工作流程需求。

## 主要功能需求

### 1. 檔案選取與內容複製

- **標準勾選框**：
  - 每個檔案/資料夾項目的左側必須顯示標準的方形勾選框（checkbox）
  - 勾選框必須能直接透過點擊切換選取/取消選取狀態
  - 未選取狀態顯示為空白方框，選取狀態顯示為帶勾號的方框
  - 勾選框必須與檔案/資料夾名稱保持適當間距，且垂直對齊

- **階層選取行為**：
  - 當勾選資料夾時，自動連帶勾選其內所有子檔案
  - 當取消勾選資料夾時，自動取消勾選其內所有子檔案
  - 當部分子檔案被選取時，父資料夾應顯示為「部分選取」狀態

- **專案根目錄選取**：
  - 在檔案樹的最上層顯示專案根目錄節點
  - 勾選根目錄節點時自動選取專案中所有檔案
  - 根目錄應顯示專案中所有檔案的總 tokens 數量與百分比

- **複製功能**：
  - 點擊「複製到剪貼簿」按鈕後，將所有勾選檔案的內容複製到剪貼簿
  - 複製過程中顯示進度指示
  - 複製完成後顯示成功訊息，包含複製的檔案數量和總 tokens 數

### 2. 檔案列表與篩選功能

- **樹狀檔案列表**：
  - 檔案列表呈現為可展開與摺疊的樹狀結構
  - 檔案和資料夾使用不同圖示區分
  - 每個項目（包括資料夾）右側顯示 tokens 數量，若設定 tokens 上限，則同時顯示百分比
  - 資料夾的 tokens 數量應為其所有子檔案 tokens 的總和

- **篩選框**：
  - 必須實作為固定位於檔案列表上方的搜尋輸入框
  - 輸入框左側顯示扁平化的搜尋圖示（使用 SVG 向量圖示）
    - 簡潔的圓形放大鏡設計，帶有延伸把手
    - 線條清晰的單色輪廓風格，符合現代UI設計標準
    - 採用16x16像素尺寸，確保在輸入框中比例適當
    - 使用currentColor屬性以自動適應主題顏色變化 
  - 輸入框右側顯示清除按鈕，僅在有搜尋內容時才顯示
  - 預設顯示提示文字「搜尋檔案...」
  - 輸入時即時篩選檔案列表，根據檔案名稱進行模糊比對
  - 清除按鈕點擊後立即清空篩選條件並重置檔案列表
  - 提供一個開關，可讓使用者選擇是否只顯示已勾選的檔案

- **搜尋結果視圖**：
  - 當篩選框有內容時，切換到列表視圖顯示搜尋結果
  - 列表視圖應顯示檔案的完整路徑，便於辨識
  - 無結果時顯示友好的空結果提示
  - 搜尋結果中的項目點擊區域應寬裕易點選
  - 當搜尋結果中包含資料夾時，其勾選框狀態應正確反映其所有子項目的選取狀態（全選、部分選取或未選取）
  - 在搜尋結果視圖中勾選/取消勾選資料夾時，應同步更新其所有子項目的選取狀態，即使這些子項目不在當前搜尋結果中

### 3. 底部摘要列

- **摘要列設計**：
  - 必須實作為固定在檔案列表底部的資訊區域
  - 左側顯示已選取檔案數量（例如：「6 files selected」）
  - 左側同時顯示已選取檔案的總 tokens 數量
  - 若設定 tokens 上限，則顯示進度條和百分比文字
  - 右側顯示「複製到剪貼簿」按鈕，使用藍色突顯
  - 勾選與取消時，摘要列應立即反映最新的檔案數量及預估 Tokens 總量

### 4. 狀態持久化與自動更新

- **持久化要求**：
  - Context Explorer 的狀態 (如選取勾選狀態、資料夾展開或摺疊狀態) 應在 VSCode 關閉後保留，下次開啟時恢復
  - 重新開啟 VSCode 後，必須立即完全恢復之前的選取狀態
  - 切換到其他視圖再切回時，選取狀態也應保持不變
  - 選取功能在狀態恢復後必須維持正常操作，包括選取/取消選取功能
  - 狀態必須按專案區分儲存，避免跨專案干擾
  - 搜尋欄位(Search)的內容不應被保存，每次重新開啟 VSCode 或重新載入插件時，搜尋欄位應重置為空
  - 在視圖切換時（切換到其他視圖再切回），搜尋欄位內容也應保持，但視圖重新初始化時應清空

- **檔案變更處理**：
  - 若上次勾選的檔案已經被刪除或不存在，則下次開啟時自動取消該檔案的勾選狀態，並即時更新摘要列資訊
  - 檔案移動或重命名後，應正確追蹤檔案狀態

### 5. 錯誤處理與日誌記錄

- **錯誤日誌記錄**：
  - 擴展必須實作一個專用的 OutputChannel，用於記錄操作日誌與錯誤訊息
  - 所有重要操作（如檔案讀取、複製操作、WebView 通信）都要記錄日誌
  - 錯誤訊息必須包含詳細資訊，包括錯誤堆疊追蹤（stack trace）
  - 當發生錯誤時，自動顯示 OutputChannel 以便用戶查看錯誤細節

- **用戶錯誤提示**：
  - 在 WebView 介面中顯示友好的錯誤提示，如浮動訊息
  - 複製操作失敗時，WebView 中必須顯示具體錯誤原因
  - 錯誤提示應包含基本錯誤資訊，避免技術細節困擾用戶
  - 錯誤訊息必須有清晰的視覺區分（如紅色背景）

- **復原機制**：
  - 複製失敗後自動復原按鈕狀態，使用戶可立即重試
  - 處理文件不存在、權限不足等常見錯誤情況

### 6. 排除規則設定

- **.gitignore 整合**：
  - 自動讀取並遵循專案中的 .gitignore 規則
  - 在設定中提供選項控制是否遵循 .gitignore 
  - 當遵循 .gitignore 時，自動排除被忽略的檔案和目錄

### 7. 設定按紐
  - 在檔案瀏覽器標題區域提供標準的設定齒輪圖示 (⚙️)
  - 點擊後直接開啟 VSCode 設定頁面，並自動聚焦到 Copy For AI 的設定區
  - 排除規則直接透過 VSCode 的標準設定介面進行管理，無需額外的自定義設定面板
  - 支援使用 .gitignore 規則來定義要排除的檔案

## 技術實作細節

### 1. UI 整合

- **視圖容器結構**：
  - 在 package.json 中註冊專用的視圖容器 (viewContainer)
  - 僅註冊一個單一視圖（ContextExplorerView），此視圖內部同時包含篩選框、檔案列表和摘要列三個元素
  - 篩選框固定於視圖頂部，檔案列表位於中間可垂直滾動區域，摘要列固定於底部
  - 三個元素之間不得使用分隔線或視覺分割，應呈現為一個整體單獨區塊
  - 視覺風格應統一且連貫，避免明顯的視圖分隔或邊界線

- **視圖實作方式**：
  - **使用單一 Webview 實作**，不再使用 VSCode 原生 TreeView API
  - 內部建議使用 HTML/CSS/JavaScript 框架（如 React、Vue、Svelte 或純 JS）自行實作樹狀檔案列表元件，支援可展開摺疊的樹狀結構、勾選框、以及檔案項目的 token 數量顯示
  - 篩選框和摘要列也在同一個 Webview 中以 HTML/CSS/JS 完成實作
  - 篩選框即時篩選檔案列表內容，並即時更新檔案列表視圖
  - 摘要列即時根據選取狀態、token數量更新內容，左側顯示檔案數量與總 tokens，右側提供複製按鈕
  
- **Webview 與擴展主程序通信**：
  - Webview 內部 UI 操作（如篩選、勾選、展開/摺疊）實時通知擴展主程序
  - 擴展主程序根據檔案系統變化（新增、刪除、移動、重命名）即時通知 Webview 更新檔案列表與勾選狀態

### 2. API 使用指南

- **檔案勾選實作**：
  - 由於 VSCode TreeView 不直接支援勾選框，必須自定義勾選框元素
  - 在 Webview 中使用 HTML/CSS/JavaScript 自行實作勾選框元素
  - 實作點擊切換勾選狀態的事件處理機制
  - 針對資料夾項目實作連動勾選/取消勾選所有子項目的功能

- **Webview 通信**：
  - 使用 postMessage 和 onDidReceiveMessage 建立 Webview 與擴展主程序間的通信
  - 確保訊息傳遞的同步和穩定性
  - 所有檔案操作（如獲取檔案列表、讀取檔案內容）都由擴展主程序處理，並通過消息傳遞給 Webview
  - Webview 中的 UI 狀態變更（如勾選狀態、展開/摺疊狀態）通過消息傳遞給擴展主程序以便持久化保存

- **狀態儲存**：
  - 使用 extensionContext.workspaceState 或 extensionContext.globalState 儲存狀態
  - 使用 webview.setState 和 webview.getState 保存臨時狀態，確保切換視圖時不丟失狀態
  - 狀態格式需包含文件 URI、選取狀態和展開狀態
  - 在擴展啟動時立即載入並應用已儲存的狀態
  - 按專案區分儲存狀態，避免跨專案干擾
  - 當 Webview 初始化時，傳送已保存的狀態給 Webview 以恢復 UI 狀態

- **檔案監控與狀態更新**：
  - 使用 VSCode 的檔案系統監控 API（FileSystemWatcher）監聽檔案變化
  - 當檔案被刪除、移動或重命名時，通過消息通知 Webview 更新 UI
  - Webview 接收到文件變更通知後，即時更新檔案列表和勾選狀態

- **錯誤日誌與顯示**：
  - 使用 vscode.window.createOutputChannel 創建日誌頻道
  - 使用 vscode.window.showErrorMessage 顯示重要錯誤提示
  - 實作自定義日誌函數，統一記錄格式和時間戳
  - 在 WebView 中實作錯誤訊息顯示機制

### 3. 性能處理策略

- **大型專案和檔案處理**：
  - 在 Webview 中實作虛擬滾動（virtual scrolling）機制，僅渲染可見區域的檔案項目
  - 大型檔案列表採用分頁加載策略，由主程序分批傳送檔案資訊給 Webview
  - 設定單一檔案大小上限（例如 5MB），超過上限的檔案需要警告使用者

- **篩選性能優化**：
  - 在 Webview 中實作篩選節流（debounce，約 300ms），減少頻繁輸入時的性能問題
  - 使用效率高的模糊比對演算法，支援大型專案篩選
  - 僅在檔案名稱上執行篩選，不篩選檔案內容
  - 篩選操作優先在 Webview 端完成，避免不必要的通信開銷

- **檔案系統限制**：
  - 預設排除特定類型的檔案或資料夾（如 node_modules、.git、build、dist、bin 等）
  - 遵循 .gitignore 規則，自動排除被忽略的檔案
  - 忽略二進制檔案、圖片等非文字檔案
  - 檔案列表初始加載由主程序準備，應用排除規則後再傳送到 Webview

## 輸出格式與現有功能整合

1. **輸出格式**：
   - 使用與現有 Copy For AI 功能相同的基本格式（簡單格式，無上下文分析）
   - 應用現有的 copyForAI.outputFormat 設定（markdown、xml、json、custom）
   - 複製整個檔案時不顯示行數，直接以檔案路徑名稱作為標題
   - 不使用 Copy For AI (With Context) 的進階功能
   - 格式處理邏輯應在擴展主程序中進行，Webview 僅負責觸發複製操作

2. **交互方式**：
   - 提供固定的側邊欄，內含單一 Webview
   - Webview 負責所有使用者互動和 UI 呈現
   - 複製操作由 Webview 觸發，但實際的檔案讀取和格式處理由主程序執行

## 使用者互動流程

1. **開啟流程**：
   - 點擊左側活動欄中的「Copy For AI」圖示，開啟側邊欄
   - 側邊欄加載單一 Webview，其中包含篩選框（頂部）、檔案樹（中間）和摘要列（底部）
   - 擴展主程序載入之前儲存的選取狀態，並通過消息傳送給 Webview
   - Webview 初始化完成後立即應用已儲存的檔案選取和展開/摺疊狀態

2. **選取流程**：
   - 在 Webview 中點擊檔案/資料夾前的勾選框，切換選取狀態
   - 選取狀態變更時，Webview 即時更新 UI 並向主程序發送消息更新狀態
   - 資料夾選取狀態變更時，Webview 中的所有子項目同步更新勾選狀態
   - 摘要列在 Webview 中即時更新檔案數量和 token 預估

3. **搜尋流程**：
   - 在 Webview 中的篩選框中輸入文字，檔案列表即時切換為列表視圖顯示搜尋結果
   - 搜尋結果顯示檔案的完整路徑，便於辨識
   - 點擊清除按鈕或按下 ESC 鍵，清除搜尋條件，回到樹狀視圖
   - 篩選操作完全在 Webview 端完成，無需與主程序通信

4. **複製流程**：
   - 點擊 Webview 中摘要列上的「複製到剪貼簿」按鈕
   - Webview 向主程序發送複製請求，包含所有已選取檔案的資訊
   - 主程序讀取所有選取檔案內容，應用格式處理，並複製到剪貼簿
   - 複製過程中，主程序通知 Webview 顯示進度指示器
   - 複製完成後，主程序通知 Webview 顯示成功訊息
   - 內容已複製到剪貼簿，可直接貼到 AI 工具中

5. **設定排除規則流程**：
   - 點擊設定按鈕，開啟 VSCode 設定頁面，自動聚焦到 Copy For AI 設定區
   - 設定頁面中提供排除規則設定，包括是否遵循 .gitignore 規則
   - 使用者可編輯排除模式，支援 .gitignore 語法
   - 設定修改後即時生效，更新檔案樹顯示

6. **錯誤處理流程**：
   - 當發生錯誤時，主程序記錄詳細錯誤資訊到 OutputChannel
   - 主程序發送錯誤狀態和簡明錯誤訊息到 WebView
   - WebView 顯示友好的錯誤提示，並恢復操作按鈕狀態
   - 對於嚴重錯誤，自動顯示 OutputChannel 讓用戶查看詳細問題
   - 用戶可重新嘗試操作或調整選取的檔案

## 輸出格式範例

````markdown
## File: src/extension.ts
```typescript
import * as vscode from 'vscode';
import { processCode, removeComments } from './codeAnalyzer';
import { formatOutput } from './formatter';

export function activate(context: vscode.ExtensionContext) {
    console.log('擴展 "copy-for-ai" 已啟動！');
}
```

## File: src/file2.ts
```typescript
export function activate(context: vscode.ExtensionContext) {
    console.log('擴展 "copy-for-ai" 已啟動！');
}
```
````

## 實作檢查清單

為確保功能符合需求，請確認以下項目：

- [x] Webview 正確載入並顯示在側邊欄
- [x] 檔案勾選框在 Webview 中顯示且可正常切換狀態
- [x] 資料夾選取行為正確，能連帶選取/取消選取所有子項目
- [x] 專案根目錄節點顯示，且能一次選取所有檔案
- [!] 篩選框位於 Webview 頂部，並能即時篩選文件
  - [x] BUG: 當資料夾名稱符合搜尋條件時，也要顯示
  - [ ] BUG: 在篩選模式下 資料夾的勾選顯示不正常（資料夾勾選狀態必須正確反映其所有子項目選取狀態，且勾選操作必須影響所有子項目）
- [x] 搜尋時切換到列表視圖顯示結果
- [x] 摘要列在 Webview 底部顯示，包含選取數量、tokens 數及複製按鈕
- [x] Webview 與擴展主程序間通信正常，狀態同步無誤
- [x] 重新開啟 VSCode 後，Webview 能正確恢復之前的選取狀態，Search 欄位清空
- [x] 切換到其他視圖再切回時，選取狀態保持不變
  - [x]ISSUE: 切換視圖後，Search 欄位會消失
- [ ]ISSUE: 關掉 VSCode 後再開啟，Search 應該要消失，目前是保留 Search 的內容（每次 VSCode 重啟後，搜尋欄位必須重置為空）
- [x] 更新設定後立刻生效
  - [x] BUG: 更新 Token Limit 後，摘要列沒有立即更新，檔案列表也沒有更新 % 數，要到切換到其他視圖再切回才會更新 
- [x] Token 數量和百分比正確計算和顯示
- [x] 資料夾顯示其所有子檔案的 tokens 總和
- [x] .gitignore 規則被正確應用
- [x] 設定按鈕正確開啟設定
- [x] FIXME: 設定按紐的樣式和整體風格不太一致，通常使用齒輪圖示 (⚙️)，顏色也應該是灰色
- [x] FIXME: 設定按鈕的位置不太合適, 應該放在 TitleBar View Action 中
- [x] 複製功能能  正確將所有選取文件內容複製到剪貼簿
- [x] Webview 在各種螢幕尺寸下顯示正常，支援響應式設計
- [x] 錯誤日誌正確記錄到 OutputChannel
- [x] 錯誤訊息在 WebView 中正確顯示
- [x] 複製操作失敗時提供明確的錯誤提示
- [x] 檔案路徑處理正確，避免相對路徑錯誤
- [x] FIXME: 輸入框左側 SVG 圖示需要修正到如需求所述的樣式
- [ ] BUG: 僅顯示已選取的右邊，還有保留舊的設定按紐，那個應該要移除了（必須移除可能存在的重複設定按鈕，只保留 TitleBar 中的一個）